# Домшнее задание №4 - кэш на SQLite

Цель этого задания -- реализовать кэш на основе базы данных SQLite в существующем приложении, которое показывает расписание поездов РЖД между Санкт-Петербургом и Москвой на любую выбранную дату. В рамках этого задания надо будет создать свой класс на основе `SQLiteOpenHelper` для доступа к БД, реализовать создание и апгрейд таблицы с расписанием, запись и чтение данных.

Приложение состоит из двух экранов:
- Экран выбора маршрута
- Экран расписания

## Экран выбора маршрута

Этот экран показывает станцию отправления и станцию прибытия. Возможность выбора станции отсутсвует -- для демонстрации зафиксирован маршрут Санкт-Петербург - Москва. По клику на кнопку "Расписание V1" или "Расписание V2" происходит переход на экран расписания для выбранного маршрута. Эти две кнопки отличаются версией модели данных, которые должны использоваться в кэше (об этом ниже). 

<img src="https://github.com/IFMO-Android-2016/homework4/blob/master/screenshots/select_route.png" width="360px"/>

Код экрана выбора маршрута написан в классе `SelectRouteActivity`.

## Экран расписания

При открытии экрана внизу показывается сегодняшняя дата и начинается загрузка расписания для выбранного маршрута и даты, при этом показывается индикатор прогресса. За загрузку данных отвечает класс `TimetableLoader` -- он выполняет запросы к сервису РЖД и получает расписание для выбранных маршрута и даты. После окончания загрузки показывается список поездов или сообщение об ошибке.

<img src="https://github.com/IFMO-Android-2016/homework4/blob/master/screenshots/timetable.png" width="360px"/>

В нижней части экрана есть кнопки, позволяющие перейти к следующей или предыдущей дате -- по нажатию на них дата сменяется и загрузка расписания начинается заново для новой выбранной даты.

## Кэш расписаний

Кэш расписаний, который предстоит реализовать, позволяет сохранить полученное из сети расписание в базу данных и в следующий раз, когда для экрана расписания понадобится загрузить данные для какого-то маршрута и даты -- прочитать эти данные из базы данны и не выполнять сетевой запрос. Кэш позволяет ускорить загрузку данных и уменьшить количество сетевых запросов (что в свою очередь может сэкономить трафик пользователю и уменьшить нагрузку на сервера).

В качестве ключа для кэша используется комбинация из трех значений: ID станции отправления, ID станции прибытия и дата. В рамках задания мы предполагаем, что расписание между двумя станциями на один день никогда не меняется, поэтому его можно прочитать из кэша и показать пользователю, не выполняя нового запроса. 

В коде приложения уже есть класс `TimetableCache`, который определяет методы для записи и чтения данных -- их вам предстоит реализовать. Загрузчик расписания `TimetableLoader` уже содержит код, который вызывает методы `TimetableCache` для чтения и записи данных, но так как кэш не реализован, загрузчик ничего не получает из кэша и поэтому всегда выполняет новый запрос. Когда задание будет выполнено, загрузчик автоматически начнет использовать кэш, и при открытии расписания для ранее просмотренной даты, расписание будет сразу загружено из кэша без выполнения сетевого запроса. Для это вам не нужно менять код никаких существующих классов кроме `TimetableCache` (но, возможно, понадобится создать новые дополнительные классы).

## Модель данных

В разработке реальных приложений часто бывают ситуации, когда сначала выпускается первая версия приложения, которая поддерживает некоторую начальную модель данных. Потом в процессе развития приложения модель данных может измениться: какие-то поля добавляются, другие удаляются, появляются новые сущности. При изменении модели данных выпускается новая версия приложения, которая поддерживает все изменения. Но кэш, созданный в первой версии приложения, содержит данные в старом формате, соответсвующем начальной модели данных. Новая версия приложения должна уметь прочитать данные в старом формати и проапгрейдить кэш. В случае базы данных SQLite новая версия приложения может добавить/удалить колонки в таблицах или создать новые таблицы. 

В рамках этого задания нужно поддержать две версии модели данных. В отличие от реальных приложений, где одновременно используется только одна модель данных, в этом демо приложении можно выбрать версию модели данных -- за это и отвечают две кнопки "Расписание V1" и "Расписание V2" на первом экране. Конструктор `TimetableCache` принимает номер версии (1 или 2) в качестве параметра. В зависимости от этого параметра он должен работать с одной или с другой версией модели данных.

Демо приложение реализовано так, что при одном запуске, пока работает процесс приложения, можно выбрать только одну версию. Другую версию можно выбрать, только если остановить процесс приложения и запустить его снова (обычно достаточно выйти по кнопке Back в домашний экран и нажать на иконку приложения снова, но на некоторых устройствах может потребоваться зайти в Менеджер приложений в системных настройках и принудительно остановаить приложение). Это сделано для того, чтобы не возникло ситуации, когда во время работы приложения нужно закрыть БД и открыть ее снова -- так обычно никто не делает, это сложно и чревато багами. При реализации кэша вы можете считать, что во время работы приложения версия модели данных не меняется -- это значит, что `SQLiteOpenHelper` можно создать один раз, хранить его в синглтоне и никогда не закрывать.


